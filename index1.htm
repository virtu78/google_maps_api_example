<!DOCTYPE html>
<html>
<head>
<title>
</title>
<meta charset="Windows-1251-8">
<style type="text/css">
#distance{ 
    width: 600px;
	height:20px;	
   	position: relative;
    float: left;
	left:1px;
   }
#map { 
    width: 600px;
	height:600px;	
    background: #ccc;
	position: relative;
    border: solid 1px black; 
	float: left;
   }
 </style>  
  
</head>
<body >


<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://j.maxmind.com/app/geoip.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
<div class="field">
	<label for="addres">Введите адрес назначения:</label>
	<input type="text" id="address">
</div>
<div class="field">
	<select id="units">
		<option  selected value="IMPERIAL">мили</option>
		<option  value="METRIC">километры</option>
	</select>
</div>
<div>
	<input type="button" id="go" value="Рассчитать маршрут">
</div>
<div id="distance"></div>
<div id="map"></div>
<script>
var directionsRenderer;
var directionsService = new google.maps.DirectionsService();
var map;
$(document).ready(function(){
	//Устанавливаем начальную точку для  Google Maps.
	//Задаем начальные координаты: широта:56, долгото:60
	//Устанавливаем уровень масштабирования равный 4, чтобы было видно большую часть территории
	var sverdlov = new google.maps.LatLng(56, 60);
	var myOptions = {
		zoom: 6,
		mapTypeId:google.maps.MapTypeId.ROADMAP,
		center:sverdlov
	}
	map = new google.maps.Map(document.getElementById("map"), myOptions);
	directionsRenderer = new google.maps.DirectionsRenderer();
	directionsRenderer.setMap(map);
	//проверяем нажатие кнопки
	$('#go').click(function(){
		//пользуем нашу новую функцию getLatting  с обратным вызовом
		//и определяем встраиваемую функцию для обработки обратного вызова.
		getLatLng(function(latitude, longitude, isMaxMind){
		//станавливаем начальную точку
		var start = new google.maps.LatLng(latitude, longitude);
		//получаем введенный пользователем адрес
		var address = $('#address').val();
		if(address){
			//станавливаем конечную точку
			var end = $('#address').val();
			//Задаем параметры запроса
				var request = {
				origin: start,
				destination: end,
				travelMode: google.maps.DirectionsTravelMode.DRIVING
			};
			//запрашиваем маршрут
			directionsService.route(request, function(result, status){
				if(status == google.maps.DirectionsStatus.OK){
					//отображаем маршрут с помощью
					//DirectionsRenderer.setDirections(result);
					directionsRenderer.setDirections(result);
					//отдельно выводим общую длину маршрута
					var distance = getTotalDistance(result);
					//выводим значение либо в милях, либо в километрах
					var units = $('units').val();
					if (units == 'IMPERIAL'){
						$('#distance').html('Общая длина маршрута: <strong>' + metersToMiles(distance) + '</strong> миль');
					}else{
						$('#distance').html('Общая длина маршрута: <strong>' + metersToKilometers(distance) + '</strong> км');
					}
				}else{
					error("Не удалось расчитать маршрут, так как: " + status);
				}
		});
	}else{
		error('Пожалуста введите адрес');
	}
	//если для определения местоположения использовали MaxMind,
	//необходимо добавить ссылку на сайт авторов
	if (isMaxMind){
		$('body').append('<p><a href="http://www.maxmind.com" target="_blank">IP to location Service Provided by MaxMind</a></p>');
			}
		});
	});
});
function getLatLng(callback){
	//озможностей геолокации
	if (navigator && navigator.geolocation){
		//запрашиваем местоположение пользователя
		navigator.geolocation.getCurrentPosition(function (position){
			//обработчик для случая успеха
			callback(position.coords.latitude, position.coords.longitude);
		},
		function(err){
			//обрабатываем ошибку, передавая обратному вызову данные
			//тестоположения, полученные от MaxMind
			callback(geip_latitude(), geoip_longitude(), true);
		});
	}else{
		//возможности геолокации недоступны, поэтому передаем обратному
		//вызову местоположение, полученное от MaxMind
		callback(geip_latitude(), geoip_longitude(), true);
	}
}
//возвращаем общую длину маршрута в метрах
function getTotalDistance(result){
	var meters = 0;
	var route = result.routes[0];
	for (li = 0; li < route.legs.length; li++){
		//Google  хранит значение длины маршрута в метрах
		meters +=route.legs[li].distance.value;
	}
	return meters;
}
function metersToKilometers(meters){
	return Math.round(meters/1000);
}
function metersToMiles(meters){
	return Math.round(meters/1689.344);
}
function error(msg){
alert(msg);
}
</script>
</body>
</html>
